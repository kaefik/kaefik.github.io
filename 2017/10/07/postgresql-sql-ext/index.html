<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <meta name="yandex-verification" content="f7918c520c4b54dd" />
        <title>PostgreSQL - язык SQL (расширенные возможности)</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="https://github.com/kaefik">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="/">Общественная записная книжка  <strong>следы для себя и потомков</strong></a></h1>
                <nav><ul>
                </ul>
<form id="search" action"#" onsubmit="javascript:window.open('https://duckduckgo.com/?q='+document.getElementById('keywords').value+'+site:www.kaefik.ru');">
                        <input id="keywords" type="text" />
                    </form>
                </nav>
<div id="submenu">
                    <ul>
                            <li><a href="/category/anime.html">anime</a></li>
                            <li><a href="/category/arduino.html">arduino</a></li>
                            <li><a href="/category/bios.html">bios</a></li>
                            <li><a href="/category/blogger.html">blogger</a></li>
                            <li><a href="/category/c.html">c#</a></li>
                            <li><a href="/category/chromeos.html">chromeos</a></li>
                            <li><a href="/category/clojure.html">clojure</a></li>
                            <li><a href="/category/design.html">design</a></li>
                            <li><a href="/category/docker.html">docker</a></li>
                            <li><a href="/category/emacs.html">emacs</a></li>
                            <li><a href="/category/english.html">english</a></li>
                            <li><a href="/category/familytree.html">familytree</a></li>
                            <li><a href="/category/freepbx.html">freepbx</a></li>
                            <li><a href="/category/game.html">game</a></li>
                            <li><a href="/category/git.html">git</a></li>
                            <li><a href="/category/go.html">go</a></li>
                            <li><a href="/category/hackintosh.html">hackintosh</a></li>
                            <li><a href="/category/hobby.html">hobby</a></li>
                            <li><a href="/category/internet.html">internet</a></li>
                            <li><a href="/category/java.html">java</a></li>
                            <li><a href="/category/javascript.html">javascript</a></li>
                            <li><a href="/category/lego.html">lego</a></li>
                            <li><a href="/category/linux.html">linux</a></li>
                            <li><a href="/category/lua.html">lua</a></li>
                            <li><a href="/category/machine_learning.html">machine_learning</a></li>
                            <li><a href="/category/main.html">main</a></li>
                            <li><a href="/category/markdown.html">markdown</a></li>
                            <li><a href="/category/miband.html">miband</a></li>
                            <li><a href="/category/minecraft.html">minecraft</a></li>
                            <li><a href="/category/miui.html">miui</a></li>
                            <li><a href="/category/money.html">money</a></li>
                            <li><a href="/category/mongodb.html">mongodb</a></li>
                            <li><a href="/category/mouse.html">mouse</a></li>
                            <li><a href="/category/network.html">network</a></li>
                            <li><a href="/category/openstreetmap.html">openstreetmap</a></li>
                            <li><a href="/category/os.html">os</a></li>
                            <li><a href="/category/otkrytye-dannye.html">открытые данные</a></li>
                            <li><a href="/category/postgis.html">postgis</a></li>
                            <li class="active"><a href="/category/postgresql.html">PostgreSQL</a></li>
                            <li><a href="/category/powershell.html">powershell</a></li>
                            <li><a href="/category/programming.html">programming</a></li>
                            <li><a href="/category/projects.html">projects</a></li>
                            <li><a href="/category/python.html">python</a></li>
                            <li><a href="/category/radio.html">radio</a></li>
                            <li><a href="/category/rest-api.html">rest-api</a></li>
                            <li><a href="/category/rust.html">rust</a></li>
                            <li><a href="/category/sailfish.html">sailfish</a></li>
                            <li><a href="/category/security.html">security</a></li>
                            <li><a href="/category/selenium.html">selenium</a></li>
                            <li><a href="/category/shell.html">shell</a></li>
                            <li><a href="/category/swift.html">swift</a></li>
                            <li><a href="/category/tatar.html">tatar</a></li>
                            <li><a href="/category/ubuntu.html">ubuntu</a></li>
                            <li><a href="/category/upwork.html">upwork</a></li>
                            <li><a href="/category/video.html">video</a></li>
                            <li><a href="/category/vim.html">vim</a></li>
                            <li><a href="/category/voice-assistant.html">voice-assistant</a></li>
                            <li><a href="/category/vscode.html">vscode</a></li>
                            <li><a href="/category/web.html">web</a></li>
                            <li><a href="/category/wifi.html">wifi</a></li>
                            <li><a href="/category/windows.html">windows</a></li>
                    </ul>
                <div>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/10/07/postgresql-sql-ext/" rel="bookmark"
           title="Permalink to PostgreSQL - язык SQL (расширенные возможности)">PostgreSQL - язык SQL (расширенные возможности)</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Sat 07 October 2017</span>
<span>| tags: <a href="/tag/db.html">db</a><a href="/tag/postgresql.html">PostgreSQL</a><a href="/tag/bazy-dannykh.html">базы данных</a><a href="/tag/sql.html">sql</a></span>
</footer><!-- /.post-info -->      <h2>Представления</h2>
<p>можно создать представление по данному запросу, фактически присвоить имя запросу, а затем обращаться к нему как к обычной таблице:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">myview</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span> <span class="n">temp_lo</span><span class="p">,</span> <span class="n">temp_hi</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="k">location</span>
    <span class="k">FROM</span> <span class="n">weather</span><span class="p">,</span> <span class="n">cities</span>
    <span class="k">WHERE</span> <span class="n">city</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</pre></div>


<p>Представления позволяют вам скрыть внутреннее устройство ваших таблиц, которые могут меняться по мере развития приложения, за надёжными интерфейсами.</p>
<h2>Внешние ключи</h2>
<p>Давайте рассмотрим следующую задачу: вы хотите добиться, чтобы никто не мог вставить в таблицу weather строки, для которых не находится соответствующая строка в таблице cities. Это называется обеспечением ссылочной целостности данных.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cities</span> <span class="p">(</span>
 <span class="n">city</span>   <span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
 <span class="k">location</span> <span class="n">point</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">weather</span> <span class="p">(</span>
  <span class="n">city</span>   <span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">references</span> <span class="n">cities</span><span class="p">(</span><span class="n">city</span><span class="p">),</span>
  <span class="n">temp_lo</span>  <span class="nb">int</span><span class="p">,</span>
  <span class="n">temp_hi</span>  <span class="nb">int</span><span class="p">,</span>
  <span class="n">prcp</span>   <span class="nb">real</span><span class="p">,</span>
  <span class="nb">date</span>   <span class="nb">date</span>
<span class="p">);</span>
</pre></div>


<p>Более подробно можно посмотреть <a href="https://postgrespro.ru/docs/postgresql/9.5/ddl.html">здесь</a></p>
<h2>Транзакции</h2>
<p>Суть транзакции в том, что она объединяет последовательность действий в одну операцию "всё или ничего". Промежуточные состояния внутри последовательности не видны другим транзакциям, и если что-то помешает успешно завершить транзакцию, ни один из результатов этих действий не сохранится в базе данных.
Другая важная характеристика транзакционных баз данных тесно связана с атомарностью изменений: когда одновременно выполняется множество транзакций, каждая из них не видит незавершённые изменения, произведённые другими. Например, если одна транзакция подсчитывает баланс по отделениям, будет неправильно, если она посчитает расход в отделении Алисы, но не учтёт приход в отделении Боба, или наоборот. Поэтому свойство транзакций "всё или ничего" должно определять не только, как изменения сохраняются в базе данных, но и как они видны в процессе работы. Изменения, производимые открытой транзакцией, невидимы для других транзакций, пока она не будет завершена, а затем они становятся видны все сразу.
В PostgreSQL транзакция определяется набором SQL-команд, окружённым командами BEGIN и COMMIT. Таким образом, наша банковская транзакция должна была бы выглядеть так:</p>
<div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">accounts</span> <span class="k">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Alice&#39;</span><span class="p">;</span>
<span class="c1">-- ...</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>


<p>Если в процессе выполнения транзакции мы решим, что не хотим фиксировать её изменения (например, потому что оказалось, что баланс Алисы стал отрицательным), мы можем выполнить команду ROLLBACK вместо COMMIT, и все наши изменения будут отменены.
PostgreSQL на самом деле отрабатывает каждый SQL-оператор как транзакцию. Если вы не вставите команду BEGIN, то каждый отдельный оператор будет неявно окружён командами BEGIN и COMMIT (в случае успешного завершения). Группу операторов, окружённых командами BEGIN и COMMIT иногда называют блоком транзакции.</p>
<p>Операторами в транзакции можно также управлять на более детальном уровне, используя точки сохранения. Точки сохранения позволяют выборочно отменять некоторые части транзакции и фиксировать все остальные. Определив точку сохранения с помощью SAVEPOINT, при необходимости вы можете вернуться к ней с помощью команды ROLLBACK TO. Все изменения в базе данных, произошедшие после точки сохранения и до момента отката, отменяются, но изменения, произведённые ранее, сохраняются.
Когда вы возвращаетесь к точке сохранения, она продолжает существовать, так что вы можете откатываться к ней несколько раз. С другой стороны, если вы уверены, что вам не придётся откатываться к определённой точке сохранения, её можно удалить, чтобы система высвободила ресурсы. Помните, что при удалении или откате к точке сохранения все точки сохранения, определённые после неё, автоматически уничтожаются.
Всё это происходит в блоке транзакции, так что в других сеансах работы с базой данных этого не видно. Совершённые действия становятся видны для других сеансов все сразу, только когда вы фиксируете транзакцию, а отменённые действия не видны вообще никогда.</p>
<div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">accounts</span> <span class="k">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Alice&#39;</span><span class="p">;</span>
<span class="n">SAVEPOINT</span> <span class="n">my_savepoint</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">accounts</span> <span class="k">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Bob&#39;</span><span class="p">;</span>
<span class="c1">-- ошибочное действие... забыть его и использовать счёт Уолли</span>
<span class="k">ROLLBACK</span> <span class="k">TO</span> <span class="n">my_savepoint</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">accounts</span> <span class="k">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span>
  <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Wally&#39;</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>


<p>Этот пример, конечно, несколько надуман, но он показывает, как можно управлять выполнением команд в блоке транзакций, используя точки сохранения. Более того, ROLLBACK TO — это единственный способ вернуть контроль над блоком транзакций, оказавшимся в прерванном состоянии из-за ошибки системы, не считая возможности полностью отменить её и начать снова.</p>
<h2>Оконная функция</h2>
<p>Оконная функция выполняет вычисления для набора строк, некоторым образом связанных с текущей строкой. Можно сравнить её с агрегатной функцией, но, в отличие от обычной агрегатной функции, при использовании оконной функции несколько строк не группируются в одну, а продолжают существовать отдельно. Внутри же, оконная функция, как и агрегатная, может обращаться не только к текущей строке результата запроса.</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">depname</span><span class="p">,</span> <span class="n">empno</span><span class="p">,</span> <span class="n">salary</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">depname</span><span class="p">)</span>
 <span class="k">FROM</span> <span class="n">empsalary</span><span class="p">;</span>
</pre></div>


<p>Вызов оконной функции всегда содержит предложение OVER, следующее за названием и аргументами оконной функции. Это синтаксически отличает её от обычной или агрегатной функции. Предложение OVER определяет, как именно нужно разделить строки запроса для обработки оконной функцией. Предложение PARTITION BY, дополняющее OVER, указывает, что строки нужно разделить по группам или разделам, объединяя одинаковые значения выражений PARTITION BY. Оконная функция вычисляется по строкам, попадающим в один раздел с текущей строкой.</p>
<p>Вы можете также определять порядок, в котором строки будут обрабатываться оконными функциями, используя ORDER BY в OVER. (Порядок ORDER BY для окна может даже не совпадать с порядком, в котором выводятся строки.)</p>
<p>Строки, обрабатываемые оконной функцией, представляют собой "виртуальные таблицы", созданные из предложения FROM и затем прошедшие через фильтрацию и группировку WHERE и GROUP BY и, возможно, условие HAVING. Например, строка, отфильтрованная из-за нарушения условия WHERE, не будет видна для оконных функций. Запрос может содержать несколько оконных функций, разделяющих данные по-разному с помощью разных предложений OVER, но все они будут обрабатывать один и тот же набор строк этой виртуальной таблицы.</p>
<p>Есть ещё одно важное понятие, связанное с оконными функциями: для каждой строки существует набор строк в её разделе, называемый рамкой окна. По умолчанию, с указанием ORDER BY рамка состоит из всех строк от начала раздела до текущей строки и строк, равных текущей по значению выражения ORDER BY. Без ORDER BY рамка по умолчанию состоит из всех строк раздела.</p>
<p>Оконные функции разрешается использовать в запросе только в списке SELECT и предложении ORDER BY. Во всех остальных предложениях, включая GROUP BY, HAVING и WHERE, они запрещены. Это объясняется тем, что логически они выполняются после обычных агрегатных функций, а значит агрегатную функцию можно вызвать из оконной, но не наоборот.</p>
<h2>Наследование</h2>
<p>- это концепция, взятая из объектно-ориентированных баз данных</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cities</span> <span class="p">(</span>
 <span class="n">name</span>    <span class="nb">text</span><span class="p">,</span>
 <span class="n">population</span> <span class="nb">real</span><span class="p">,</span>
 <span class="n">altitude</span>  <span class="nb">int</span>   <span class="c1">-- (высота в футах)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">capitals</span> <span class="p">(</span>
 <span class="k">state</span>   <span class="nb">char</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">)</span> <span class="k">INHERITS</span> <span class="p">(</span><span class="n">cities</span><span class="p">);</span>  <span class="c1">-- наследование столбцов из таблицы cities</span>
</pre></div>


<p>В PostgreSQL таблица может наследоваться от нуля или нескольких других таблиц.</p>
<p>Например, следующий запрос выведет названия всех городов, включая столицы, находящихся выше 500 футов над уровнем моря:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">altitude</span>
 <span class="k">FROM</span> <span class="n">cities</span>
 <span class="k">WHERE</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">;</span>
</pre></div>


<p>А следующий запрос находит все города, которые не являются столицами штатов, но также находятся выше 500 футов:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">altitude</span>
  <span class="k">FROM</span> <span class="k">ONLY</span> <span class="n">cities</span>
  <span class="k">WHERE</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">;</span>
</pre></div>


<p>Здесь слово ONLY перед названием таблицы cities указывает, что запрос следует выполнять только для строк таблицы cities, не включая таблицы, унаследованные от cities. Многие операторы, которые мы уже обсудили — SELECT, UPDATE и DELETE — поддерживают указание ONLY.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/oILnur">Twitter</a></li>
                            <li><a href="mailto: ilnursoft@gmail.com">Email</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>