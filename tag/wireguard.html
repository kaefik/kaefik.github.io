<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <meta name="yandex-verification" content="f7918c520c4b54dd" />
        <title>Общественная записная книжка - wireguard</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="https://github.com/kaefik">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="/">Общественная записная книжка  <strong>следы для себя и потомков</strong></a></h1>
                <nav><ul>
                </ul>
<form id="search" action"#" onsubmit="javascript:window.open('https://duckduckgo.com/?q='+document.getElementById('keywords').value+'+site:www.kaefik.ru');">
                        <input id="keywords" type="text" />
                    </form>
                </nav>
<div id="submenu">
                    <ul>
                            <li><a href="/category/anime.html">anime</a></li>
                            <li><a href="/category/arduino.html">arduino</a></li>
                            <li><a href="/category/bios.html">bios</a></li>
                            <li><a href="/category/blogger.html">blogger</a></li>
                            <li><a href="/category/chromeos.html">chromeos</a></li>
                            <li><a href="/category/clojure.html">clojure</a></li>
                            <li><a href="/category/design.html">design</a></li>
                            <li><a href="/category/docker.html">docker</a></li>
                            <li><a href="/category/english.html">english</a></li>
                            <li><a href="/category/freepbx.html">freepbx</a></li>
                            <li><a href="/category/game.html">game</a></li>
                            <li><a href="/category/git.html">git</a></li>
                            <li><a href="/category/go.html">go</a></li>
                            <li><a href="/category/hackintosh.html">hackintosh</a></li>
                            <li><a href="/category/hobby.html">hobby</a></li>
                            <li><a href="/category/internet.html">internet</a></li>
                            <li><a href="/category/javascript.html">javascript</a></li>
                            <li><a href="/category/lego.html">lego</a></li>
                            <li><a href="/category/linux.html">linux</a></li>
                            <li><a href="/category/lua.html">lua</a></li>
                            <li><a href="/category/machine_learning.html">machine_learning</a></li>
                            <li><a href="/category/main.html">main</a></li>
                            <li><a href="/category/markdown.html">markdown</a></li>
                            <li><a href="/category/miband.html">miband</a></li>
                            <li><a href="/category/minecraft.html">minecraft</a></li>
                            <li><a href="/category/miui.html">miui</a></li>
                            <li><a href="/category/money.html">money</a></li>
                            <li><a href="/category/mongodb.html">mongodb</a></li>
                            <li><a href="/category/mouse.html">mouse</a></li>
                            <li><a href="/category/network.html">network</a></li>
                            <li><a href="/category/openstreetmap.html">openstreetmap</a></li>
                            <li><a href="/category/os.html">os</a></li>
                            <li><a href="/category/otkrytye-dannye.html">открытые данные</a></li>
                            <li><a href="/category/postgis.html">postgis</a></li>
                            <li><a href="/category/postgresql.html">PostgreSQL</a></li>
                            <li><a href="/category/powershell.html">powershell</a></li>
                            <li><a href="/category/programming.html">programming</a></li>
                            <li><a href="/category/projects.html">projects</a></li>
                            <li><a href="/category/python.html">python</a></li>
                            <li><a href="/category/radio.html">radio</a></li>
                            <li><a href="/category/rest-api.html">rest-api</a></li>
                            <li><a href="/category/rust.html">rust</a></li>
                            <li><a href="/category/sailfish.html">sailfish</a></li>
                            <li><a href="/category/security.html">security</a></li>
                            <li><a href="/category/selenium.html">selenium</a></li>
                            <li><a href="/category/shell.html">shell</a></li>
                            <li><a href="/category/swift.html">swift</a></li>
                            <li><a href="/category/tatar.html">tatar</a></li>
                            <li><a href="/category/upwork.html">upwork</a></li>
                            <li><a href="/category/video.html">video</a></li>
                            <li><a href="/category/vim.html">vim</a></li>
                            <li><a href="/category/voice-assistant.html">voice-assistant</a></li>
                            <li><a href="/category/vpn.html">vpn</a></li>
                            <li><a href="/category/vscode.html">vscode</a></li>
                            <li><a href="/category/web.html">web</a></li>
                            <li><a href="/category/wifi.html">wifi</a></li>
                            <li><a href="/category/windows.html">windows</a></li>
                    </ul>
                <div>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/2020/10/04/vpn-wireguard/">Настройка vpn WireGuard</a></h1>
<footer class="post-info">
        <span>Sun 04 October 2020</span>
<span>| tags: <a href="/tag/vpn.html">vpn</a><a href="/tag/linux.html">linux</a><a href="/tag/android.html">android</a><a href="/tag/wireguard.html">wireguard</a></span>
</footer><!-- /.post-info --><h2>Полезные ссылки</h2>
<ul>
<li><a href="https://www.wireguard.com">WireGuard official page</a> </li>
<li><a href="https://linuxize.com/post/how-to-set-up-wireguard-vpn-on-ubuntu-18-04/">How to Set Up WireGuard VPN on Ubuntu 18.04</a></li>
<li><a href="https://www.youtube.com/watch?v=myn6yE1wgK4">Setting Up WireGuard Client On Android</a></li>
</ul>
<h2>Настройка сервера</h2>
<ol>
<li>Установка</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">sudo apt install wireguard</span>
</pre></div>


<ol>
<li>Генерация public и private ключей</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">wg genkey | sudo tee /etc/wireguard/privatekey | wg pubkey | sudo tee /etc/wireguard/publickey</span>
</pre></div>


<ol>
<li>Создание конфигурации интерфейса vpn /etc/wireguard/wg0.conf:</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">[Interface]</span>
<span class="na">Address</span> <span class="o">=</span> <span class="s">10.0.0.1/24</span>
<span class="na">SaveConfig</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">ListenPort</span> <span class="o">=</span> <span class="s">51820</span>
<span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">SERVER_PRIVATE_KEY</span>
<span class="na">PostUp</span> <span class="o">=</span> <span class="s">iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE</span>
<span class="na">PostDown</span> <span class="o">=</span> <span class="s">iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE</span>
</pre></div>


<p>где </p>
<ul>
<li>SERVER_PRIVATE_KEY - содержимое файла /etc/wireguard/privatekey</li>
<li>PostUp - command or script which is executed before bringing the interface up. In this example, we’re using iptables to enable masquerading. This will allow traffic to leave the server, giving the VPN clients access to the Internet.
Make sure to replace ens3 after -A POSTROUTING to match the name of your public network interface. You can easily find the interface by running the following command:</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">ip -o -4 route show to default | awk &#39;{print $5}&#39;</span>
</pre></div>


<ul>
<li>
<p>PostDown - command or script which is executed before bringing the interface down. The iptables rules will be removed once the interface is down.</p>
</li>
<li>
<p>файлы wg0.conf и privatekey не должны быть доступны обычным пользователям:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">sudo chmod 600 /etc/wireguard/{privatekey,wg0.conf}</span>
</pre></div>


<ol>
<li>поднять интерфейс wg0</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">wg-quick up wg0 </span>
<span class="err">wg show wg0</span>
<span class="err">ip a show wg0</span>
<span class="err">sudo systemctl enable wg-quick@wg0</span>
</pre></div>


<ol>
<li>Настройки сети и фаервола</li>
<li>добавить в файл /etc/sysctl.conf строку:</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">net.ipv4.ip_forward=1</span>
</pre></div>


<ul>
<li>применить изменения:</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">sudo sysctl -p</span>
</pre></div>


<ul>
<li>открыть порт 51820:</li>
</ul>
<div class="highlight"><pre><span></span><span class="err">sudo ufw allow 51820/udp</span>
</pre></div>


<h2>Настройка клиента Android</h2>
<ol>
<li>генерация ключей для клиента</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">cd /etc/wireguard/</span>
<span class="err">wg genkey | sudo tee phone_privatekey | wg pubkey &gt; phone_publickey</span>
</pre></div>


<ol>
<li>создадим файл конфигурации android2.conf</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">[Interface]</span>
<span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">&lt;приватный ключ из файла phone_privatekey&gt;</span>
<span class="na">Address</span> <span class="o">=</span> <span class="s">10.0.0.3/32</span>
<span class="na">DNS</span> <span class="o">=</span> <span class="s">8.8.8.8</span>

<span class="k">[Peer]</span>
<span class="na">PublicKey</span> <span class="o">=</span> <span class="s">&lt;public ключ сервера в моём случае из файла publickey&gt;</span>
<span class="na">Endpoint</span> <span class="o">=</span> <span class="s">&lt;ip server&gt;:51820</span>
</pre></div>


<ol>
<li>добавим в конец файла wg0.conf информацию о подключении:</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">[Peer]</span>
<span class="na">PublicKey</span> <span class="o">=</span> <span class="s">&lt;public ключ из файла phone_publickey&gt;</span>
<span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">10.0.0.3/32</span>
</pre></div>


<ol>
<li>перезапустим интерфейс wg0:</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">wg-quick down wg0</span>
<span class="err">wg-quick up wg0</span>
</pre></div>


<ol>
<li>установим программу генерации qr-кодов на сервере:</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">apt install qrencode</span>
</pre></div>


<ol>
<li>генерация qr-кода который отсканируем в программе WireGuard на андроиде:</li>
</ol>
<div class="highlight"><pre><span></span><span class="err">qrencode -t utf8 &lt; android2.conf</span>
</pre></div>


<ol>
<li>пробуем подключаться к впн.</li>
</ol>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/oILnur">Twitter</a></li>
                            <li><a href="mailto: ilnursoft@gmail.com">Email</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>